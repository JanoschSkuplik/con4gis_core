<?php

/**
 * Contao Open Source CMS
 *
 * @version   php 5
 * @package   con4gis
 * @author    Tobias Dobbrunz
 * @license   GNU/LGPL http://opensource.org/licenses/lgpl-3.0.html
 * @copyright KÃ¼stenschmiede GmbH Software & Design 2014
 * @link      https://www.kuestenschmiede.de
 * @filesource 
 */

namespace c4g;


class C4GMigration extends \BackendModule
{
	protected $strTemplate = 'be_c4g_migration';
    protected $module = '';
    protected $action = '';
    protected $output = '';
    protected $buttons = array();

    /**
     * [__construct description]
     * @param [type] $mod [description]
     */
    public function __construct( $mod )
    {
        parent::__construct();
        // import database
        // $this->import('Database');

        // set targeted module
        $this->module = $mod;

    }

	/**
     * Generate the module
     * @return string
     */
    public function generate()
    {
        if (\Input::get('act') != '') {
            $this->action = \Input::get('act');
            switch( \Input::get('act') )
            {
                case 'exec':
                    $this->migrate();
                    break;
                default:
                    break;
            }
        }

        $this->buttons[] = array(
            action  => 'exec',
            label   => $GLOBALS['TL_LANG']['MSC']['C4G_BE_INFO']['BTN']['MIGRATE']
        );

        return parent::generate();
    }

    /**
     * Generate the module
     */
    protected function compile()
    {
    	$this->Template->mod = $this->module;

        $this->Template->action = $this->action ?: false;
        $this->Template->output = $this->output ?: '';

        $this->Template->buttons = $this->buttons ?: '';

    	// $GLOBALS['TL_CSS'][] = 'system/modules/con4gis_core/assets/css/be_c4g_info.css';
        // $this->Template->c4gModules->con4gis_maps->installed = $GLOBALS[];
    }


    protected function migrate()
    {
        $successCount = 0;
        $errorCount = 0;
        // [tricky]: little specialcasing for cfs_maps, since most of the tables are named "cfs_map"
        $mod = ($this->module == 'maps') ? 'map' : $this->module;

        // fetch all related tables
        foreach ($this->Database->listTables() as $table) {
            if (C4GUtils::startsWith($table, 'tl_cfs_'.$mod)) {
                // calculate the new name
                $newTable = str_replace('_cfs_', '_c4g_', $table);
                $output = $table . ' &emsp;<span style="color:#999">-&gt;</span> ' . $newTable . ':<br> &nbsp; ';
                // copy the data and generate an appropriate output
                try {
                    // recreate new table (since "DISABLE KEYS" didn't work)
                    $this->Database->prepare( "DROP TABLE $newTable" )->execute();
                    $this->Database->prepare( "CREATE TABLE $newTable LIKE $table" )->execute();
                    $output .= $this->Database->prepare( "INSERT INTO $newTable SELECT * FROM $table" )->execute()? 
                            ' <span style="color:#090"> DONE </span>' :
                            ' <span style="color:#900"> ERROR </span>';
                    $successCount++;
                } catch (Exception $e) {
                    $errorCount++;
                    $output .= ' <span style="color:#900"> ERROR <span>';
                }

                $this->output[] = $output; 
            }
        }


        array_unshift( $this->output, $successCount.' wins & '.$errorCount.' fails', '' );
    }

}
?>